--Cria a tabela de produtos 
CREATE TABLE PRODUTOS (
	CODIGO VARCHAR(10),
	DESCRICAO VARCHAR(50), 
	PRECO DECIMAL(6,2),
	CONSTRAINT PK_PRODUTOS_COD  PRIMARY KEY (CODIGO)
);

--Insere 10 produtos 

INSERT INTO PRODUTOS (CODIGO, DESCRICAO, PRECO) VALUES ('1', 'Produto 1', 29.9);
INSERT INTO PRODUTOS (CODIGO, DESCRICAO, PRECO) VALUES ('2', 'Produto 2', 129.3);
INSERT INTO PRODUTOS (CODIGO, DESCRICAO, PRECO) VALUES ('3', 'Produto 3', 69.4);
INSERT INTO PRODUTOS (CODIGO, DESCRICAO, PRECO) VALUES ('4', 'Produto 4', 569.6);
INSERT INTO PRODUTOS (CODIGO, DESCRICAO, PRECO) VALUES ('5', 'Produto 5', 999.1);
INSERT INTO PRODUTOS (CODIGO, DESCRICAO, PRECO) VALUES ('6', 'Produto 6', 10.4);
INSERT INTO PRODUTOS (CODIGO, DESCRICAO, PRECO) VALUES ('7', 'Produto 7', 19.1);
INSERT INTO PRODUTOS (CODIGO, DESCRICAO, PRECO) VALUES ('8', 'Produto 8', 54.9);
INSERT INTO PRODUTOS (CODIGO, DESCRICAO, PRECO) VALUES ('9', 'Produto 9', 15);
INSERT INTO PRODUTOS (CODIGO, DESCRICAO, PRECO) VALUES ('10', 'Produto 10', 15);

--Cria a tabela de pedidos 

CREATE TABLE CLIENTES (
	CODIGO VARCHAR(10), 
	NOME VARCHAR(100),
	CONSTRAINT PK_CLIENTES PRIMARY KEY (CODIGO)
);

--Insere 20 clientes 

INSERT INTO CLIENTES (CODIGO, NOME) VALUES ('1', 'Cliente 1');
INSERT INTO CLIENTES (CODIGO, NOME) VALUES ('2', 'Cliente 2');
INSERT INTO CLIENTES (CODIGO, NOME) VALUES ('3', 'Cliente 3');
INSERT INTO CLIENTES (CODIGO, NOME) VALUES ('4', 'Cliente 4');
INSERT INTO CLIENTES (CODIGO, NOME) VALUES ('5', 'Cliente 5');
INSERT INTO CLIENTES (CODIGO, NOME) VALUES ('6', 'Cliente 6');
INSERT INTO CLIENTES (CODIGO, NOME) VALUES ('7', 'Cliente 7');
INSERT INTO CLIENTES (CODIGO, NOME) VALUES ('8', 'Cliente 8');
INSERT INTO CLIENTES (CODIGO, NOME) VALUES ('9', 'Cliente 9');
INSERT INTO CLIENTES (CODIGO, NOME) VALUES ('10', 'Cliente 10');
INSERT INTO CLIENTES (CODIGO, NOME) VALUES ('11', 'Cliente 11');
INSERT INTO CLIENTES (CODIGO, NOME) VALUES ('12', 'Cliente 12');
INSERT INTO CLIENTES (CODIGO, NOME) VALUES ('13', 'Cliente 13');
INSERT INTO CLIENTES (CODIGO, NOME) VALUES ('14', 'Cliente 14');
INSERT INTO CLIENTES (CODIGO, NOME) VALUES ('15', 'Cliente 15');
INSERT INTO CLIENTES (CODIGO, NOME) VALUES ('16', 'Cliente 16');
INSERT INTO CLIENTES (CODIGO, NOME) VALUES ('17', 'Cliente 17');
INSERT INTO CLIENTES (CODIGO, NOME) VALUES ('18', 'Cliente 18');
INSERT INTO CLIENTES (CODIGO, NOME) VALUES ('19', 'Cliente 19');
INSERT INTO CLIENTES (CODIGO, NOME) VALUES ('20', 'Cliente 20');

--Cria a tabela de pedidos 
CREATE TABLE PEDIDOS(
	CODIGO VARCHAR(10), 
	CODCLIENTE VARCHAR(10), 
	DATAPEDIDO DATETIME,
	CONSTRAINT PK_PEDIDOS PRIMARY KEY (CODIGO, CODCLIENTE), 
	CONSTRAINT FK_PEDIDOS_CLIENTES FOREIGN KEY (CODCLIENTE) REFERENCES CLIENTES (CODIGO)
);

--[VAI GERAR ERRO ] Insere um pedido para um cliente que nao existe 
--The INSERT statement conflicted with the FOREIGN KEY constraint "FK_PEDIDOS_CLIENTES". The conflict occurred in database "Teste", table "dbo.CLIENTES", column 'CODIGO'. 
--Erro acontece porque o código do cliente 123456 não existe 
--INSERT INTO PEDIDOS (CODIGO, CODCLIENTE, DATAPEDIDO) VALUES ('1', '123456', '2024-01-01');


--Insere 5 pedidos para diferentes clientes 
INSERT INTO PEDIDOS (CODIGO, CODCLIENTE, DATAPEDIDO) VALUES ('1', '1', '2024-01-01');
INSERT INTO PEDIDOS (CODIGO, CODCLIENTE, DATAPEDIDO) VALUES ('2', '2', '2024-01-05');
INSERT INTO PEDIDOS (CODIGO, CODCLIENTE, DATAPEDIDO) VALUES ('3', '3', '2024-01-10');
INSERT INTO PEDIDOS (CODIGO, CODCLIENTE, DATAPEDIDO) VALUES ('4', '4', '2024-01-15');
INSERT INTO PEDIDOS (CODIGO, CODCLIENTE, DATAPEDIDO) VALUES ('5', '5', '2024-01-20');


--Cria a tabela de itens do pedido 

CREATE TABLE PEDIDOSITENS(
	CODIGO VARCHAR(10), 
	CODCLIENTE VARCHAR(10),
	CODPEDIDO VARCHAR(10), 
	CODPRODUTO VARCHAR(10), 
	QUANTIDADE DECIMAL (6, 2)
	CONSTRAINT PK_PEDIDOSITENS PRIMARY KEY (CODIGO, CODPEDIDO, CODPRODUTO), 
	CONSTRAINT FK_PEDIDOSITENS_PED FOREIGN KEY (CODPEDIDO, CODCLIENTE) REFERENCES PEDIDOS (CODIGO, CODCLIENTE), 
	CONSTRAINT FK_PEDIDOSITENS_PROD FOREIGN KEY (CODPRODUTO) REFERENCES PRODUTOS (CODIGO)
);

--Insere os itens dos pedidos. Atenção com a relação da tabela pedido itens 
INSERT INTO PEDIDOSITENS (CODIGO, CODCLIENTE, CODPEDIDO, CODPRODUTO, QUANTIDADE) VALUES ('1', '1', '1', '1', 2);
INSERT INTO PEDIDOSITENS (CODIGO, CODCLIENTE, CODPEDIDO, CODPRODUTO, QUANTIDADE) VALUES ('2', '1', '1', '2', 5);

INSERT INTO PEDIDOSITENS (CODIGO, CODCLIENTE, CODPEDIDO, CODPRODUTO, QUANTIDADE) VALUES ('3', '2', '2', '8', 11);
INSERT INTO PEDIDOSITENS (CODIGO, CODCLIENTE, CODPEDIDO, CODPRODUTO, QUANTIDADE) VALUES ('4', '2', '2', '9', 100);

INSERT INTO PEDIDOSITENS (CODIGO, CODCLIENTE, CODPEDIDO, CODPRODUTO, QUANTIDADE) VALUES ('5', '3', '3', '8', 9);
INSERT INTO PEDIDOSITENS (CODIGO, CODCLIENTE, CODPEDIDO, CODPRODUTO, QUANTIDADE) VALUES ('6', '3', '3', '9', 90);

INSERT INTO PEDIDOSITENS (CODIGO, CODCLIENTE, CODPEDIDO, CODPRODUTO, QUANTIDADE) VALUES ('7', '4', '4', '8', 85);
INSERT INTO PEDIDOSITENS (CODIGO, CODCLIENTE, CODPEDIDO, CODPRODUTO, QUANTIDADE) VALUES ('8', '4', '4', '9', 15);

INSERT INTO PEDIDOSITENS (CODIGO, CODCLIENTE, CODPEDIDO, CODPRODUTO, QUANTIDADE) VALUES ('9', '5', '5', '8', 14);
INSERT INTO PEDIDOSITENS (CODIGO, CODCLIENTE, CODPEDIDO, CODPRODUTO, QUANTIDADE) VALUES ('10', '5', '5', '9', 2044);
INSERT INTO PEDIDOSITENS (CODIGO, CODCLIENTE, CODPEDIDO, CODPRODUTO, QUANTIDADE) VALUES ('11', '5', '5', '9', 364);
INSERT INTO PEDIDOSITENS (CODIGO, CODCLIENTE, CODPEDIDO, CODPRODUTO, QUANTIDADE) VALUES ('12', '5', '5', '9', 6);


--[ COM ERRO ]  Exemplo de um insert que não funciona por causa da relação de chave composta criada 
--INSERT INTO PEDIDOSITENS (CODIGO, CODCLIENTE, CODPEDIDO, CODPRODUTO, QUANTIDADE) VALUES ('5', '3', '2', '8', 9);
--INSERT INTO PEDIDOSITENS (CODIGO, CODCLIENTE, CODPEDIDO, CODPRODUTO, QUANTIDADE) VALUES ('6', '3', '2', '9', 90);


--Insere um novo pedido para um cliente que já realizou pedidos 
INSERT INTO PEDIDOS (CODIGO, CODCLIENTE, DATAPEDIDO) VALUES ('100', 5, '2024-01-31');
INSERT INTO PEDIDOSITENS (CODIGO, CODCLIENTE, CODPEDIDO, CODPRODUTO, QUANTIDADE) VALUES ('50', '5', '100', '4', 44);
INSERT INTO PEDIDOSITENS (CODIGO, CODCLIENTE, CODPEDIDO, CODPRODUTO, QUANTIDADE) VALUES ('51', '5', '100', '8', 88);
INSERT INTO PEDIDOSITENS (CODIGO, CODCLIENTE, CODPEDIDO, CODPRODUTO, QUANTIDADE) VALUES ('52', '5', '100', '10', 1010);


--====================================================================================
--Mudanças nas estruturas para utilizar o ID como chave primaria em todas as tabelas 
--====================================================================================

--Adicionando colunas ID nas tabelas 
ALTER TABLE PRODUTOS ADD ID INT;
ALTER TABLE CLIENTES ADD ID INT;
ALTER TABLE PEDIDOS ADD ID INT;
ALTER TABLE PEDIDOSITENS ADD ID INT;


--Altera a estrutura das PKs 
ALTER TABLE PEDIDOSITENS DROP CONSTRAINT PK_PEDIDOSITENS;
ALTER TABLE PEDIDOSITENS DROP CONSTRAINT FK_PEDIDOSITENS_PED;
ALTER TABLE PEDIDOSITENS DROP CONSTRAINT FK_PEDIDOSITENS_PROD;
ALTER TABLE PEDIDOS DROP CONSTRAINT PK_PEDIDOS;
ALTER TABLE PEDIDOS DROP CONSTRAINT FK_PEDIDOS_CLIENTES;
ALTER TABLE CLIENTES DROP CONSTRAINT PK_CLIENTES;
ALTER TABLE PRODUTOS DROP CONSTRAINT PK_PRODUTOS_COD;

--Atualiza os IDs com os códigos antigos 
UPDATE PEDIDOSITENS SET ID = CAST (CODIGO  AS int);
UPDATE PEDIDOS SET ID = CODIGO ;
UPDATE CLIENTES SET ID = CODIGO;
UPDATE PRODUTOS SET ID = CODIGO;

--Define como not null as colunas 
ALTER TABLE PEDIDOSITENS ALTER COLUMN ID INT NOT NULL;
ALTER TABLE PEDIDOS ALTER COLUMN ID INT NOT NULL;
ALTER TABLE CLIENTES ALTER COLUMN ID INT NOT NULL;
ALTER TABLE PRODUTOS ALTER COLUMN ID INT NOT NULL;

--Altera as tabelas para que tenham o campo ID como chave primária (PK) 
ALTER TABLE PEDIDOSITENS ADD CONSTRAINT PK_PEDIDOSITENS_ID PRIMARY KEY (ID);
ALTER TABLE PEDIDOS ADD CONSTRAINT PK_PEDIDOS_ID PRIMARY KEY (ID);
ALTER TABLE CLIENTES ADD CONSTRAINT PK_CLIENTES_ID PRIMARY KEY (ID);
ALTER TABLE PRODUTOS ADD CONSTRAINT PK_PRODUTOS_ID PRIMARY KEY (ID);

ALTER TABLE CLIENTES DROP COLUMN CODIGO;
ALTER TABLE PEDIDOS DROP COLUMN CODIGO;
ALTER TABLE PEDIDOSITENS DROP COLUMN CODIGO;
ALTER TABLE PEDIDOSITENS DROP COLUMN CODCLIENTE;
ALTER TABLE PRODUTOS DROP COLUMN CODIGO;

ALTER TABLE PEDIDOS ADD IDCLIENTE INT;
UPDATE PEDIDOS SET IDCLIENTE = CODCLIENTE;
ALTER TABLE PEDIDOS DROP COLUMN CODCLIENTE;
ALTER TABLE PEDIDOS ADD CONSTRAINT FK_PEDIDOS_CLIENTE FOREIGN KEY (IDCLIENTE) REFERENCES CLIENTES (ID);

ALTER TABLE PEDIDOSITENS ADD IDPEDIDO INT;
ALTER TABLE PEDIDOSITENS ADD IDPRODUTO INT;
UPDATE PEDIDOSITENS SET IDPEDIDO = CODPEDIDO, IDPRODUTO = CODPRODUTO;
ALTER TABLE PEDIDOSITENS DROP COLUMN CODPEDIDO, CODPRODUTO;

ALTER TABLE PEDIDOSITENS ADD CONSTRAINT FK_PEDIDOSITENS_PEDIDO FOREIGN KEY (IDPEDIDO) REFERENCES PEDIDOS (ID);
ALTER TABLE PEDIDOSITENS ADD CONSTRAINT FK_PEDIDOSITENS_PRODUTO FOREIGN KEY (IDPRODUTO) REFERENCES PRODUTOS (ID);